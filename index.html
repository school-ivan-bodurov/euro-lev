<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BGN/EUR Scanner & Change</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: manipulation;
        }
        .ios-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        #video-container {
            position: relative;
            overflow: hidden;
            border-radius: 1.5rem;
            background: #000;
        }
        .scanner-laser {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 10px 2px rgba(59, 130, 246, 0.8);
            animation: scanning 2s infinite linear;
        }
        @keyframes scanning {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        .detected-badge {
            animation: pop 0.3s ease-out;
        }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Скриване на стрелките на input type=number */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen pb-64">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/80 ios-blur border-b p-4 text-center">
        <h1 class="text-xl font-bold text-blue-600">BGN ⟷ EUR Scanner</h1>
        <p class="text-xs text-gray-500">Курс: 1.95583</p>
    </header>

    <main class="p-4 space-y-4 max-w-lg mx-auto">
        
        <!-- Camera Section -->
        <div id="video-container" class="aspect-[4/3] shadow-lg relative group">
            <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
            <div id="laser" class="scanner-laser hidden"></div>
            <div class="absolute inset-0 border-2 border-dashed border-white/20 pointer-events-none rounded-2xl m-6"></div>
        </div>

        <!-- Processing Indicator -->
        <div id="status" class="hidden text-center p-3 bg-blue-100 text-blue-700 rounded-xl text-sm animate-pulse font-medium">
            Анализиране на етикета...
        </div>

        <!-- Conversion Display -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 relative">
            <div id="currency-detected" class="absolute -top-3 right-6 hidden">
                <span class="bg-green-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-sm detected-badge uppercase">Скенерът откри суми</span>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div id="bgn-wrapper" class="p-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-widest">Лева (BGN)</label>
                    <input type="text" id="bgn-input" inputmode="decimal" class="w-full text-3xl font-black outline-none bg-transparent border-b-2 border-gray-100 focus:border-blue-500 transition-colors" placeholder="0.00">
                </div>
                <div id="eur-wrapper" class="p-2 border-l border-gray-50">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-widest">Евро (EUR)</label>
                    <input type="text" id="eur-input" inputmode="decimal" class="w-full text-3xl font-black outline-none bg-transparent border-b-2 border-gray-100 focus:border-blue-500 transition-colors" placeholder="0.00">
                </div>
            </div>
            
            <button id="add-to-cart" class="w-full mt-6 bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-[0.98] transition-all">
                Добави към сметката
            </button>
        </div>

        <!-- Payment & Change Section -->
        <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xs font-black text-blue-800 uppercase tracking-widest">Плащане</h2>
                <button id="toggle-paid-currency" class="bg-blue-600 text-white text-[10px] px-4 py-1.5 rounded-full font-bold uppercase shadow-md active:scale-90 transition-transform">
                    Валута: <span id="paid-currency-label">BGN</span>
                </button>
            </div>
            <div>
                <input type="text" id="paid-amount" inputmode="decimal" class="w-full bg-transparent text-3xl font-black outline-none border-b-2 border-blue-200 focus:border-blue-600 transition-colors" placeholder="Дадена сума">
            </div>
            <div id="change-display" class="hidden pt-4 border-t border-blue-200 animate-in fade-in duration-500">
                <p class="text-[10px] text-blue-600 font-bold uppercase mb-1">Ресто:</p>
                <div class="flex justify-between items-baseline">
                    <span id="change-bgn" class="text-3xl font-black text-green-600">0.00 лв.</span>
                    <span id="change-eur" class="text-xl font-bold text-gray-400">0.00 €</span>
                </div>
            </div>
        </div>

        <!-- Items List -->
        <div class="space-y-3 pb-20">
            <div class="flex justify-between items-center px-2">
                <h2 class="font-black text-gray-800 uppercase text-xs tracking-widest">Количка</h2>
                <button id="clear-list" class="text-[10px] bg-red-50 text-red-500 px-3 py-1 rounded-full font-bold uppercase hover:bg-red-100 transition-colors">Изчисти</button>
            </div>
            <div id="items-list" class="space-y-2"></div>
        </div>

    </main>

    <!-- Floating Action Bar (Една ръка) -->
    <div class="fixed bottom-0 left-0 right-0 z-[100] p-4 pb-8 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent">
        <div class="max-w-lg mx-auto flex flex-col gap-4">
            <!-- Scan Button - Голям и центриран за палеца -->
            <button id="capture-btn" class="w-full bg-blue-600 text-white py-5 rounded-3xl font-black text-lg shadow-[0_10px_30px_rgba(37,99,235,0.4)] active:scale-95 active:bg-blue-700 transition-all flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 free 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="Ref-M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                СКАНИРАЙ ЕТИКЕТ
            </button>

            <!-- Sticky Footer Total -->
            <div class="bg-white p-5 rounded-3xl shadow-2xl border border-gray-100 flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase font-black tracking-tighter">Обща сума</p>
                    <div class="flex gap-3 items-baseline">
                        <span id="total-bgn" class="text-2xl font-black text-gray-900">0.00 лв.</span>
                        <span id="total-eur" class="text-sm font-bold text-blue-600">0.00 €</span>
                    </div>
                </div>
                <div id="item-count" class="bg-blue-50 text-blue-700 px-4 py-2 rounded-2xl font-black text-xs uppercase">
                    0 бр.
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const RATE = 1.95583;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const bgnInput = document.getElementById('bgn-input');
        const eurInput = document.getElementById('eur-input');
        const paidInput = document.getElementById('paid-amount');
        const changeDisplay = document.getElementById('change-display');
        const changeBgnEl = document.getElementById('change-bgn');
        const changeEurEl = document.getElementById('change-eur');
        const statusDiv = document.getElementById('status');
        const laser = document.getElementById('laser');
        const itemsList = document.getElementById('items-list');
        const totalBgnEl = document.getElementById('total-bgn');
        const totalEurEl = document.getElementById('total-eur');
        const itemCountEl = document.getElementById('item-count');
        const detectedBadge = document.getElementById('currency-detected');
        
        const toggleCurrencyBtn = document.getElementById('toggle-paid-currency');
        const paidCurrencyLabel = document.getElementById('paid-currency-label');

        let cartItems = [];
        let grandTotalBgn = 0;
        let grandTotalEur = 0;
        let paidInCurrency = 'BGN';

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', focusMode: 'continuous' } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera error:", err);
            }
        }

        // HARD-FIX: Нормализация на входните данни (точка/запетая)
        function handleManualInput(inputEl, targetEl, isToEur) {
            inputEl.addEventListener('input', (e) => {
                let valStr = e.target.value.replace(',', '.');
                // Предотвратяване на повече от една точка
                const parts = valStr.split('.');
                if (parts.length > 2) valStr = parts[0] + '.' + parts[1];
                
                e.target.value = valStr; // Визуално обновяване на текущото поле

                const val = parseFloat(valStr);
                if (!isNaN(val)) {
                    if (isToEur) {
                        targetEl.value = (val / RATE).toFixed(2);
                    } else {
                        targetEl.value = (val * RATE).toFixed(2);
                    }
                } else if (valStr === '') {
                    targetEl.value = '';
                }
                calculateChange();
            });
        }

        handleManualInput(bgnInput, eurInput, true);
        handleManualInput(eurInput, bgnInput, false);

        // Същата логика за полето "Дадена сума"
        paidInput.addEventListener('input', (e) => {
            let valStr = e.target.value.replace(',', '.');
            const parts = valStr.split('.');
            if (parts.length > 2) valStr = parts[0] + '.' + parts[1];
            e.target.value = valStr;
            calculateChange();
        });

        toggleCurrencyBtn.onclick = () => {
            paidInCurrency = paidInCurrency === 'BGN' ? 'EUR' : 'BGN';
            paidCurrencyLabel.innerText = paidInCurrency;
            calculateChange();
        };

        function calculateChange() {
            const val = parseFloat(paidInput.value);
            if (isNaN(val) || (grandTotalBgn <= 0 && grandTotalEur <= 0)) {
                changeDisplay.classList.add('hidden');
                return;
            }
            
            let changeBgn, changeEur;
            if (paidInCurrency === 'BGN') {
                const change = val - grandTotalBgn;
                if (change < -0.01) { changeDisplay.classList.add('hidden'); return; }
                changeBgn = change;
                changeEur = change / RATE;
            } else {
                const changeInEur = val - grandTotalEur;
                if (changeInEur < -0.01) { changeDisplay.classList.add('hidden'); return; }
                changeEur = changeInEur;
                changeBgn = changeInEur * RATE;
            }

            changeBgnEl.innerText = `${Math.max(0, changeBgn).toFixed(2)} лв.`;
            changeEurEl.innerText = `${Math.max(0, changeEur).toFixed(2)} €`;
            changeDisplay.classList.remove('hidden');
        }

        function cleanOCRValue(rawText) {
            let cleaned = rawText.replace(/[^0-9.,]/g, '');
            cleaned = cleaned.replace(',', '.');
            const parts = cleaned.split('.');
            if (parts.length > 2) cleaned = parts[0] + '.' + parts[1].substring(0, 2);
            return cleaned;
        }

        document.getElementById('capture-btn').onclick = async () => {
            statusDiv.classList.remove('hidden');
            laser.classList.remove('hidden');
            detectedBadge.classList.add('hidden');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            try {
                const worker = await Tesseract.createWorker('bul+eng');
                const { data } = await worker.recognize(canvas);
                await worker.terminate();

                const words = data.words;
                if (!words || words.length === 0) return;

                let candidates = words.filter(w => {
                    const norm = cleanOCRValue(w.text);
                    return /\d+/.test(norm) && w.confidence > 45;
                });

                if (candidates.length === 0) return;

                candidates.sort((a, b) => (b.bbox.y1 - b.bbox.y0) - (a.bbox.y1 - a.bbox.y0));
                
                let foundBgn = null;
                let foundEur = null;

                for (let i = 0; i < Math.min(candidates.length, 6); i++) {
                    const cand = candidates[i];
                    const normText = cleanOCRValue(cand.text);
                    const val = parseFloat(normText);
                    if (isNaN(val)) continue;

                    const context = words.filter(w => {
                        const dx = Math.abs(w.bbox.x0 - cand.bbox.x0);
                        const dy = Math.abs(w.bbox.y0 - cand.bbox.y0);
                        return dx < 300 && dy < 120;
                    }).map(w => w.text.toLowerCase()).join('');

                    if ((context.includes('€') || context.includes('eur') || context.includes('e')) && !foundEur) {
                        foundEur = val;
                    } else if ((context.includes('лв') || context.includes('bgn') || context.includes('л')) && !foundBgn) {
                        foundBgn = val;
                    } else if (!foundBgn) {
                        foundBgn = val;
                    }
                }

                // АВТОМАТИЧНО ПРЕСМЯТАНЕ ПРИ ЗАСИЧАНЕ
                if (foundBgn) {
                    bgnInput.value = foundBgn.toFixed(2);
                    eurInput.value = (foundBgn / RATE).toFixed(2);
                } else if (foundEur) {
                    eurInput.value = foundEur.toFixed(2);
                    bgnInput.value = (foundEur * RATE).toFixed(2);
                }

                if (foundBgn || foundEur) {
                    detectedBadge.classList.remove('hidden');
                    window.navigator.vibrate && window.navigator.vibrate(50);
                }

            } catch (e) {
                console.error("OCR Error:", e);
            } finally {
                statusDiv.classList.add('hidden');
                laser.classList.add('hidden');
            }
        };

        document.getElementById('add-to-cart').onclick = () => {
            const bgn = parseFloat(bgnInput.value);
            const eur = parseFloat(eurInput.value);
            if (isNaN(bgn) || isNaN(eur)) return;

            cartItems.push({ id: Date.now(), bgn: bgn, eur: eur });
            updateUI();
            bgnInput.value = '';
            eurInput.value = '';
            detectedBadge.classList.add('hidden');
        };

        document.getElementById('clear-list').onclick = () => {
            cartItems = [];
            paidInput.value = '';
            updateUI();
        };

        function removeItem(id) {
            cartItems = cartItems.filter(item => item.id !== id);
            updateUI();
        }

        function updateUI() {
            itemsList.innerHTML = '';
            grandTotalBgn = 0;
            grandTotalEur = 0;
            
            cartItems.forEach(item => {
                grandTotalBgn += item.bgn;
                grandTotalEur += item.eur;
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-gray-100 animate-in slide-in-from-bottom-2 duration-300";
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-black text-gray-900">${item.bgn.toFixed(2)} лв.</span>
                        <span class="text-[10px] text-blue-500 font-bold uppercase tracking-widest">${item.eur.toFixed(2)} €</span>
                    </div>
                    <button onclick="removeItem(${item.id})" class="text-gray-300 hover:text-red-500 p-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                itemsList.prepend(div);
            });

            totalBgnEl.innerText = `${grandTotalBgn.toFixed(2)} лв.`;
            totalEurEl.innerText = `${grandTotalEur.toFixed(2)} €`;
            itemCountEl.innerText = `${cartItems.length} БР.`;
            
            calculateChange();
        }

        window.removeItem = removeItem;
        window.onload = initCamera;
    </script>
</body>
</html>