<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BGN/EUR Scanner & Change</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .ios-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        #video-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            background: #000;
        }
        .scanner-laser {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 10px 2px rgba(59, 130, 246, 0.8);
            animation: scanning 2s infinite linear;
        }
        @keyframes scanning {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        .detected-badge {
            animation: pop 0.3s ease-out;
        }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen pb-40">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/80 ios-blur border-b p-4 text-center">
        <h1 class="text-xl font-bold text-blue-600">BGN ⟷ EUR Scanner</h1>
        <p class="text-xs text-gray-500">BNB: 1.95583</p>
    </header>

    <main class="p-4 space-y-4 max-w-lg mx-auto">
        
        <!-- Camera Section -->
        <div id="video-container" class="aspect-video shadow-lg relative group">
            <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
            <div id="laser" class="scanner-laser hidden"></div>
            <div class="absolute inset-0 border-2 border-dashed border-white/30 pointer-events-none rounded-xl m-4"></div>
            
            <button id="capture-btn" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-2 rounded-full font-semibold shadow-xl active:scale-95 transition-transform">
                Снимай етикет
            </button>
        </div>

        <!-- Processing Indicator -->
        <div id="status" class="hidden text-center p-2 bg-blue-100 text-blue-700 rounded-lg text-sm animate-pulse">
            Търсене на цени BGN и EUR...
        </div>

        <!-- Conversion Display -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative">
            <div id="currency-detected" class="absolute -top-3 right-4 hidden">
                <span class="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-sm detected-badge uppercase">Скенерът откри суми</span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div id="bgn-wrapper" class="transition-all duration-300 p-2 rounded-lg border border-transparent">
                    <label class="block text-xs font-medium text-gray-400 uppercase mb-1">Лева (BGN)</label>
                    <input type="number" id="bgn-input" step="0.01" inputmode="decimal" class="w-full text-2xl font-bold outline-none bg-transparent border-b-2 border-transparent focus:border-blue-500 transition-colors" placeholder="0.00">
                </div>
                <div id="eur-wrapper" class="transition-all duration-300 p-2 rounded-lg border border-transparent">
                    <label class="block text-xs font-medium text-gray-400 uppercase mb-1">Евро (EUR)</label>
                    <input type="number" id="eur-input" step="0.01" inputmode="decimal" class="w-full text-2xl font-bold outline-none bg-transparent border-b-2 border-transparent focus:border-blue-500 transition-colors" placeholder="0.00">
                </div>
            </div>
            
            <button id="add-to-cart" class="w-full mt-6 bg-green-500 text-white py-3 rounded-xl font-bold shadow-md active:bg-green-600 transition-colors">
                Добави към сметката
            </button>
        </div>

        <!-- Payment & Change Section -->
        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 space-y-4 shadow-sm">
            <div class="flex justify-between items-center">
                <h2 class="text-sm font-bold text-blue-800 uppercase tracking-wider">Плащане и Ресто</h2>
                <button id="toggle-paid-currency" class="bg-blue-600 text-white text-[10px] px-3 py-1 rounded-full font-bold uppercase shadow-sm active:scale-95 transition-transform">
                    Валута: <span id="paid-currency-label">BGN</span>
                </button>
            </div>
            <div>
                <label class="block text-xs font-medium text-blue-600 uppercase mb-1">Дадена сума (<span id="paid-label-text">BGN</span>)</label>
                <input type="number" id="paid-amount" step="0.01" inputmode="decimal" class="w-full bg-transparent text-2xl font-bold outline-none border-b-2 border-blue-200 focus:border-blue-500 transition-colors" placeholder="Въведете сума">
            </div>
            <div id="change-display" class="hidden pt-2 border-t border-blue-200">
                <p class="text-xs text-blue-600 uppercase">Ресто:</p>
                <div class="flex justify-between items-baseline">
                    <span id="change-bgn" class="text-2xl font-black text-green-600">0.00 лв.</span>
                    <span id="change-eur" class="text-lg font-bold text-gray-500">0.00 €</span>
                </div>
            </div>
        </div>

        <!-- Items List -->
        <div class="space-y-2 pb-10">
            <div class="flex justify-between items-center px-2">
                <h2 class="font-bold text-gray-700">Списък покупки</h2>
                <button id="clear-list" class="text-xs text-red-500 font-medium hover:underline">Изчисти всичко</button>
            </div>
            <div id="items-list" class="space-y-2"></div>
        </div>

    </main>

    <!-- Footer Total -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 ios-blur shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <p class="text-xs text-gray-400 uppercase font-bold tracking-tighter">Обща сума:</p>
                <div class="flex gap-3 items-baseline">
                    <span id="total-bgn" class="text-xl font-black text-gray-800">0.00 лв.</span>
                    <span id="total-eur" class="text-base font-bold text-blue-600">0.00 €</span>
                </div>
            </div>
            <div class="text-right">
                <span class="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full font-bold" id="item-count">0 продукта</span>
            </div>
        </div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const RATE = 1.95583;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const bgnInput = document.getElementById('bgn-input');
        const eurInput = document.getElementById('eur-input');
        const paidInput = document.getElementById('paid-amount');
        const changeDisplay = document.getElementById('change-display');
        const changeBgnEl = document.getElementById('change-bgn');
        const changeEurEl = document.getElementById('change-eur');
        const statusDiv = document.getElementById('status');
        const laser = document.getElementById('laser');
        const itemsList = document.getElementById('items-list');
        const totalBgnEl = document.getElementById('total-bgn');
        const totalEurEl = document.getElementById('total-eur');
        const itemCountEl = document.getElementById('item-count');
        const detectedBadge = document.getElementById('currency-detected');
        const bgnWrapper = document.getElementById('bgn-wrapper');
        const eurWrapper = document.getElementById('eur-wrapper');
        
        const toggleCurrencyBtn = document.getElementById('toggle-paid-currency');
        const paidCurrencyLabel = document.getElementById('paid-currency-label');
        const paidLabelText = document.getElementById('paid-label-text');

        let cartItems = [];
        let grandTotalBgn = 0;
        let grandTotalEur = 0;
        let paidInCurrency = 'BGN';

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera error:", err);
            }
        }

        bgnInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (!isNaN(val)) eurInput.value = (val / RATE).toFixed(2);
        });

        eurInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (!isNaN(val)) bgnInput.value = (val * RATE).toFixed(2);
        });

        toggleCurrencyBtn.onclick = () => {
            paidInCurrency = paidInCurrency === 'BGN' ? 'EUR' : 'BGN';
            paidCurrencyLabel.innerText = paidInCurrency;
            paidLabelText.innerText = paidInCurrency;
            calculateChange();
        };

        paidInput.addEventListener('input', calculateChange);

        function calculateChange() {
            const val = parseFloat(paidInput.value);
            if (isNaN(val) || grandTotalBgn <= 0) {
                changeDisplay.classList.add('hidden');
                return;
            }
            
            let changeBgn, changeEur;
            if (paidInCurrency === 'BGN') {
                const change = val - grandTotalBgn;
                if (change < -0.01) { changeDisplay.classList.add('hidden'); return; }
                changeBgn = change;
                changeEur = change / RATE;
            } else {
                const changeInEur = val - grandTotalEur;
                if (changeInEur < -0.01) { changeDisplay.classList.add('hidden'); return; }
                changeEur = changeInEur;
                changeBgn = changeInEur * RATE;
            }

            changeBgnEl.innerText = `${Math.max(0, changeBgn).toFixed(2)} лв.`;
            changeEurEl.innerText = `${Math.max(0, changeEur).toFixed(2)} €`;
            changeDisplay.classList.remove('hidden');
        }

        document.getElementById('capture-btn').onclick = async () => {
            statusDiv.classList.remove('hidden');
            laser.classList.remove('hidden');
            detectedBadge.classList.add('hidden');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            try {
                const worker = await Tesseract.createWorker('bul+eng');
                const { data } = await worker.recognize(canvas);
                await worker.terminate();

                const words = data.words;
                if (!words || words.length === 0) return;

                // Филтрираме само думи, съдържащи числа и с добра увереност
                let candidates = words.filter(w => {
                    const cleanText = w.text.replace(',', '.');
                    return /\d+/.test(cleanText) && w.confidence > 50;
                });

                if (candidates.length === 0) return;

                // Сортираме по размер на шрифта (височина), за да хванем основните цени
                candidates.sort((a, b) => (b.bbox.y1 - b.bbox.y0) - (a.bbox.y1 - a.bbox.y0));
                
                let foundBgn = null;
                let foundEur = null;

                // Анализираме топ кандидатите (най-големите числа)
                for (let i = 0; i < Math.min(candidates.length, 5); i++) {
                    const cand = candidates[i];
                    const text = cand.text.replace(',', '.');
                    const numMatch = text.match(/\d+\.\d{2}/) || text.match(/\d+/);
                    if (!numMatch) continue;
                    
                    const val = parseFloat(numMatch[0]);

                    // Търсим контекст около това число
                    const context = words.filter(w => {
                        const dx = Math.abs(w.bbox.x0 - cand.bbox.x0);
                        const dy = Math.abs(w.bbox.y0 - cand.bbox.y0);
                        return dx < 250 && dy < 80;
                    }).map(w => w.text.toLowerCase()).join('');

                    if ((context.includes('€') || context.includes('eur')) && !foundEur) {
                        foundEur = val;
                    } else if ((context.includes('лв') || context.includes('bgn')) && !foundBgn) {
                        foundBgn = val;
                    } else if (!foundBgn) {
                        // Ако няма индикатор, но е голямо число, приемаме го за лева по подразбиране
                        foundBgn = val;
                    }
                }

                // Ако сме намерили и двете, ги попълваме директно без формула
                if (foundBgn) bgnInput.value = foundBgn.toFixed(2);
                if (foundEur) eurInput.value = foundEur.toFixed(2);
                
                // Ако липсва едното, тогава прилагаме формулата като резервен вариант
                if (foundBgn && !foundEur) eurInput.value = (foundBgn / RATE).toFixed(2);
                if (foundEur && !foundBgn) bgnInput.value = (foundEur * RATE).toFixed(2);

                if (foundBgn || foundEur) {
                    detectedBadge.classList.remove('hidden');
                }

            } catch (e) {
                console.error("OCR Error:", e);
            } finally {
                statusDiv.classList.add('hidden');
                laser.classList.add('hidden');
            }
        };

        document.getElementById('add-to-cart').onclick = () => {
            const bgn = parseFloat(bgnInput.value);
            const eur = parseFloat(eurInput.value);
            if (isNaN(bgn) || isNaN(eur)) return;

            cartItems.push({
                id: Date.now(),
                bgn: bgn,
                eur: eur
            });
            
            updateUI();
            bgnInput.value = '';
            eurInput.value = '';
            detectedBadge.classList.add('hidden');
        };

        document.getElementById('clear-list').onclick = () => {
            cartItems = [];
            paidInput.value = '';
            updateUI();
        };

        function removeItem(id) {
            cartItems = cartItems.filter(item => item.id !== id);
            updateUI();
        }

        function updateUI() {
            itemsList.innerHTML = '';
            grandTotalBgn = 0;
            grandTotalEur = 0;
            
            cartItems.forEach(item => {
                grandTotalBgn += item.bgn;
                grandTotalEur += item.eur;
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100 animate-in fade-in slide-in-from-right-4 duration-300";
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-800">${item.bgn.toFixed(2)} лв.</span>
                        <span class="text-xs text-blue-500 font-medium">${item.eur.toFixed(2)} €</span>
                    </div>
                    <button onclick="removeItem(${item.id})" class="text-red-400 p-2 active:scale-75 transition-transform">✕</button>
                `;
                itemsList.prepend(div);
            });

            totalBgnEl.innerText = `${grandTotalBgn.toFixed(2)} лв.`;
            totalEurEl.innerText = `${grandTotalEur.toFixed(2)} €`;
            itemCountEl.innerText = `${cartItems.length} продукта`;
            
            calculateChange();
        }

        window.removeItem = removeItem;
        window.onload = initCamera;
    </script>
</body>
</html>